<% provide :title, "CoderDojo 一覧 - 統計情報" %>
<% provide :desc,  "CoderDojo の公開されている統計情報をまとめたページです。" %>
<% provide :url,   dojos_url %>
<% provide :meta_image, "/img/ogp-stats.jpeg" %>

<section id='top' class='cover' style='background-color: white; max-width: 400px; margin: 0 auto;'>
  <%= lazy_image_tag "stats_cover.png", alt: "Cover Photo" %>
</section>

<section id="index" class="text-center" style="margin-bottom: 100px;">
  <br>
  <h1>☯️
    CoderDojo 一覧 - 統計情報<br><small>（公開情報のみ掲載）</small>
  </h1>
  <br>
  <p style="margin: 0 0px 40px 10px; line-height: 1.5em;">
    CoderDojo の公開されている統計情報をまとめたページです。
    <br>
    <div class='form__terms list'>
      <ul style='list-style-type: "\2713\0020"; font-size: smaller;'>
	<li>道場名をクリックすると、その道場の個別の統計データを確認できます</li>
	<li>対象期間を選ぶと、その期間のアクティブな道場の一覧を表示できます</li>
	<li>全期間の場合のみ、すべての道場（非アクティブ含む）を表示できます</li>
      </ul>
    </div>
    <div style="text-align: center; margin-top: 10px; margin-bottom: 50px;">
      <%= link_to raw('&raquo; 推移グラフで見る'), stats_path, style: 'color: #007bff; text-decoration: none;' %>
    </div>
  </p>
  
  <!-- 年次データを取得する -->
  <div style="margin: 30px auto; padding: 20px; background: #f8f9fa; border-radius: 8px; max-width: 600px;">
    <h3 id="table">
      <a href="#table">📊</a>
      年次データを取得する
    </h3>
    
    <%= render_inline_flash_messages %>
    
    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 15px;">
      <%= label_tag :year, '対象期間:', style: 'font-weight: bold;' %>
      <%= select_tag :year, 
          options_for_select(
            (2012..Date.current.year).to_a.reverse.map { |y| [y.to_s + '年', y] },
            params[:year]
          ),
          include_blank: '全期間',
          onchange: "window.location.href = this.value ? '#{dojos_path}?year=' + this.value + '#table' : '#{dojos_path}#table'",
          style: 'padding: 5px; border: 1px solid #ced4da; border-radius: 4px; cursor: pointer;' %>
      
      <%= link_to 'CSV', dojos_path(format: :csv, year: params[:year]), 
          style: 'padding: 5px 15px; background: #28a745; color: white; text-decoration: none; border-radius: 4px;' %>
      
      <%= link_to 'JSON', dojos_path(format: :json, year: params[:year]), 
          style: 'padding: 5px 15px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;' %>
    </div>
    
    <p style="font-size: smaller; color: #6c757d; margin-top: 15px;">
      対象期間を選択すると、その時点のアクティブな道場の一覧を表示・ダウンロードできます。
    </p>
  </div>

  <div style="margin-top: 20px;" align="center">
    <table border="1" class="stats-table">
      <tr>
        <th>
          <small>
	    ☯️
	    <br class='ignore-pc'>
	    道場名 (ID 番号)
	  </small>
        </th>
        <th>
          <small>
	    🗾
	    <br class='ignore-pc'>
	    <%= link_to '掲載日', signup_path %>
	  </small>
        </th>
        <th>
          <small>
	    📝
	    <br class='ignore-pc'>
	    URL
	  </small>
        </th>
      </tr>
      <% @dojos.each do |dojo| %>
        <tr>
          <% if dojo[:is_active] %>
            <td>
	      <small>
	        <%= link_to dojo_path(dojo[:id]) do %>
		  <%= dojo[:name] %><br>
		  <small>(ID: <%= dojo[:id] %>)</small>
	        <% end %>
	      </small>
            </td>
            <td>
	      <small><%= dojo[:created_at].strftime("%F") %></small>
            </td>
            <td class="url-cell">
              <small>
	        <a href='<%= dojo[:url] %>'>
		  <span title="<%= dojo[:url] %>">
		    <%= truncate(CGI.unescape(dojo[:url].gsub('https://', '').gsub('http://', '').gsub('www.', '').chomp('/')), length: 30) %>
		  </span>
	        </a>
              </small>
            </td>
          <% else %>
            <td class="inactive-item">
	      <small>
	        <%= link_to dojo_path(dojo[:id]) do %>
		  <%= dojo[:name] %><br>
		  <small>(ID: <%= dojo[:id] %>)</small>
	        <% end %>
	      </small>
            </td>
            <td class="inactive-item">
	      <small><%= dojo[:created_at].strftime("%F") %></small>
            </td>
            <td class="url-cell inactive-item">
              <small>
	        <a href='<%= dojo[:url] %>'>
		  <span title="<%= dojo[:url] %>">
		    <%= truncate(CGI.unescape(dojo[:url].gsub('https://', '').gsub('http://', '').gsub('www.', '').chomp('/')), length: 30) %>
		  </span>
	        </a>
              </small>
            </td>
          <% end %>
        </tr>
      <% end %>
    </table>

    <p>
      <pre style='white-space: pre-wrap; margin-top: 60px; color: #505050;'>本ページにある統計情報は現在、<br class='ignore-pc'><a href='https://doorkeeper.jp/'>Doorkeeper</a> と <a href='http://connpass.com/'>connpass</a> にのみ対応しています。</pre>
    </p>
    <div style='margin-top: 30px;'><a href='#top'>&uarr; 上に戻る</a></div>
  </div>
</section>
