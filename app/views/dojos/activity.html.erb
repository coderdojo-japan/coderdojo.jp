<% provide(:title, '道場別の活動状況まとめ') %>
<% provide(:desc,  '道場別の直近開催日やリンク先などをまとめた、活動状況を確認するためのページです。') %>
<% provide(:url, activity_dojos_url) %>
<% provide(:meta_image, '/img/ogp-events.jpeg') %>

<section class="cover">
  <%= lazy_image_tag('/events_cover.jpg', alt: 'Cover Photo on Upcoming Events', min: true) %>
</section>

<section id="events" class="text-center" style="margin-bottom: 100px;">
  <br />
  <h1>☯️ 道場別の活動状況まとめ</h1>
  <br />
  <p style="margin: 0 0px 40px 10px; line-height: 1.5em;">
    主にデータ分析や
    <%= link_to 'Active/Inactive', signup_path(anchor: 'terms') %>
    の判断などの用途で使われています。
    <br>
    <div class='form__terms list'>
      <ul style='list-style-type: "\2713\0020"; font-size: smaller;'>
	<li>「記録日」は<%= link_to '統計情報 (開催数)',  stats_path %> や活動の確認/記録日を表示しています。</li>
	<li>「記録日」は <a href='https://doorkeeper.jp/'>Doorkeeper</a> と <a href='http://connpass.com/'>connpass</a> の場合、自動で更新されます。</li>
	<li>「経過日」は記録日からの経過日数（<%= link_to '閾値', signup_path(anchor: 'terms') %>の確認用）を表示しています。</li>
      </ul>
    </div>
  </p>

  <div style="margin-top: 20px;" align="center">
    <table border="1" class="stats-table">
      <tr>
        <th>
          <small>
            ☯️
            <br class='ignore-pc'>
            道場名<br>
	    <small>(Dojo ID)</small>
          </small>
        </th>
        <th>
          <small>
            🗓
            <br class='ignore-pc'>
            <a href='<%= events_path %>'>記録日</a>
          </small>
        </th>
        <th>
          <small>
            ⏱️
            <br class='ignore-pc'>
            <%= link_to '経過日', signup_path(anchor: 'terms') %>
          </small>
        </th>
        <th>
          <small>
            🔍
            <br class='ignore-pc'>
            検索
          </small>
        </th>
        <th>
          <small>
            🔗
            <br class='ignore-pc'>
            URL
          </small>
        </th>
        <th>
          <small>
            📝
            <br class='ignore-pc'>
            ノート
          </small>
        </th>
      </tr>
      <% @latest_event_by_dojos.each do |dojo| %>
        <tr>
          <td class="<%= 'inactive-item' unless dojo[:is_active] %>">
            <small>
              <%= link_to dojo_path(dojo[:id]) do %>
                <%= dojo[:name] %><br>
                <small>(ID: <%= dojo[:id] %>)</small>
              <% end %>
            </small>
          </td>
          <td class="<%= 'inactive-item' unless dojo[:is_active] %>">
            <small>
              <% if dojo[:note_date] && dojo[:latest_event_at] %>
                <!-- 両方の日付がある場合：より新しい方を表示 -->
                <% if dojo[:note_date] > dojo[:latest_event_at] %>
                  <!-- note日付の方が新しい -->
                  <% expired = dojo[:note_date] <= Time.current - @inactive_threshold && !dojo[:note].include?('Active') %>
                  <span class="<%= 'expired' if expired %>">
                    <% if dojo[:note_link] %>
                      <%= link_to dojo[:note_date].strftime("%Y-%m-%d"), dojo[:note_link] %>
                    <% else %>
                      <%= dojo[:note_date].strftime("%Y-%m-%d") %>
                    <% end %>
                  </span>
                <% else %>
                  <!-- イベント履歴の方が新しいか同じ -->
                  <% expired = dojo[:latest_event_at] <= Time.current - @inactive_threshold && !dojo[:note].include?('Active') %>
                  <span class="<%= 'expired' if expired %>">
                    <%= link_to dojo[:latest_event_at].strftime("%Y-%m-%d"), dojo[:latest_event_url] %>
                  </span>
                <% end %>
              <% elsif dojo[:note_date] %>
                <!-- note日付のみ -->
                <% expired = dojo[:note_date] <= Time.current - @inactive_threshold && !dojo[:note].include?('Active') %>
                <span class="<%= 'expired' if expired %>">
                  <% if dojo[:note_link] %>
                    <%= link_to dojo[:note_date].strftime("%Y-%m-%d"), dojo[:note_link] %>
                  <% else %>
                    <%= dojo[:note_date].strftime("%Y-%m-%d") %>
                  <% end %>
                </span>
              <% elsif dojo[:latest_event_at] %>
                <!-- イベント履歴のみ -->
                <% expired = dojo[:latest_event_at] <= Time.current - @inactive_threshold && !dojo[:note].include?('Active') %>
                <span class="<%= 'expired' if expired %>">
                  <%= link_to dojo[:latest_event_at].strftime("%Y-%m-%d"), dojo[:latest_event_url] %>
                </span>
              <% else %>
                <!-- 開催日情報なし -->
                <span style="color: #999;">-</span>
              <% end %>
            </small>
          </td>
          <td class="<%= 'inactive-item' unless dojo[:is_active] %>">
            <small>
              <% 
                # 記録日を決定（note_date と latest_event_at のより新しい方）
                record_date = nil
                if dojo[:note_date] && dojo[:latest_event_at]
                  record_date = dojo[:note_date] > dojo[:latest_event_at] ? dojo[:note_date] : dojo[:latest_event_at]
                elsif dojo[:note_date]
                  record_date = dojo[:note_date]
                elsif dojo[:latest_event_at]
                  record_date = dojo[:latest_event_at]
                end
                
                if record_date
                  # 経過日数を計算
                  days_passed = (Date.current - record_date.to_date).to_i
                  expired = days_passed >= 365 && !dojo[:note]&.include?('Active')
              %>
                <span class="<%= 'expired' if expired %>">
                  <%= days_passed %> 日
                </span>
              <% else %>
                <!-- 記録日がない場合 -->
                <span style="color: #999;">-</span>
              <% end %>
            </small>
          </td>
          <td class="<%= 'inactive-item' unless dojo[:is_active] %>">
            <small><small>
              <% search_query = URI.encode_www_form(q: "CoderDojo #{dojo[:name].split('@').first.strip}") %>
              <% search_range = URI.encode_www_form(tbs: "qdr:m12") # 過去12ヶ月の検索結果 %>
              <% search_url   = "https://www.google.co.jp/search?" + search_query %>
	      
              <%= link_to '全期間', [search_url].join,                    target: "_blank" %><br>
              <%= link_to '12ヶ月', [search_url, search_range].join('&'), target: "_blank" %>
            </small></small>
          </td>
          <td class="<%= 'inactive-item' unless dojo[:is_active] %>">
            <small><small>
              <%= link_to dojo[:url], target: "_blank" do %>
                Website
		<small><i class="far fa-external-link"></i></small>
              <% end %>
            </small></small>
          </td>
          <td class="url-cell <%= 'inactive-item' unless dojo[:is_active] %>">
            <small>
              <span title="<%= dojo[:note] %>">
                <%= raw Addressable::URI.unescape(truncate_with_preserved_links(dojo[:note], length: 60)) %>
              </span>
            </small>
          </td>
        </tr>
      <% end %>
    </table>
  </div>

  <p>
    <pre style='white-space: pre-wrap; margin-top: 60px; color: #505050;'>本ページにある開催日は <br class='ignore-pc'><a href='https://doorkeeper.jp/'>Doorkeeper</a> と <a href='http://connpass.com/'>connpass</a> にのみ対応しています。</pre>
  </p>
  <div style='margin-top: 30px;'><a href='#top'>&uarr; 上に戻る</a></div>
</section>
