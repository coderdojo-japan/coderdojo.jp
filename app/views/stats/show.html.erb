<% provide(:title, @lang == 'en' ? 'Statistics' : 'çµ±è¨ˆæƒ…å ±') %>
<% provide(:desc,  @lang == 'en' ? 'Statistics of CoderDojo in Japan. Use this page to understand activities across the country.' : 'CoderDojo ã®çµ±è¨ˆæƒ…å ±ã‚’ã¾ã¨ã‚ãŸãƒšãƒ¼ã‚¸ã§ã™ã€‚å…¨å›½ã®æ´»å‹•çŠ¶æ³ã‚’æŠŠæ¡ã—ãŸã„å ´é¢ãªã©ã§ã”æ´»ç”¨ãã ã•ã„ã€‚') %>
<% provide(:url,   @lang == 'en' ? english_stats_url : stats_url) %>
<% provide(:meta_image, '/img/ogp-stats.jpeg') %>
<% provide(:lang, @lang) %>

<!-- jQuery Japan Map -->
<script type="text/javascript" src="/js/jquery.japan-map.js"></script>

<section id="top" style="padding-top:40px; background-color: white; max-width: 400px; margin: 0 auto;">
  <%= lazy_image_tag 'stats_cover.png', alt: 'Cover photo for CoderDojo Stats' %>
</section>

<section class="stats text-center">
  <h1><%= @lang == 'en' ? 'Statistics' : 'çµ±è¨ˆæƒ…å ±' %></h1>
  <div style="margin: 30px 36px 0;">
    <% if @lang == 'en' %>
      This page presents statistics of CoderDojo in Japan.<br class="ignore-sp">Use this to understand activities across the country.
    <% else %>
      æœ¬ãƒšãƒ¼ã‚¸ã§ã¯ CoderDojo ã®çµ±è¨ˆæƒ…å ±ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚<br class="ignore-sp">å…¨å›½ã®æ´»å‹•çŠ¶æ³ã‚’æŠŠæ¡ã—ãŸã„å ´é¢ãªã©ã§ã”æ´»ç”¨ãã ã•ã„ã€‚
    <% end %>
  </div>
  <div style="margin-top: 20px;">
    <% if @lang == 'en' %>
      <a href="/stats">&raquo; Switch to Japanese</a>
    <% else %>
      <a href="/english/stats">&raquo; View in English</a>
    <% end %>
  </div>

  <h2 id="graph" style="margin-top: 70px; color: #333333;">
    <a href="#graph">ğŸ“Š</a>
    <%= @lang == 'en' ? 'Transition Charts' : 'æ¨ç§»ã‚°ãƒ©ãƒ•' %>
  </h2>

  <style>
    /* ä¸­å¤®å¯„ã›ã«ã™ã‚‹ */
    .chart-wrapper { margin: 40px auto; }
  </style>
  <div align="center">
    <%= high_chart_globals(@high_charts_globals) %>

    <!-- é“å ´æ•°ã€é–‹å‚¬æ•°ã€å‚åŠ æ•°ã®æ¨ç§»ã‚°ãƒ©ãƒ• -->
    <div class='chart-wrapper'><%= high_chart("annual_dojos",           @annual_dojos_chart) %></div>
    <div class='chart-wrapper'><%= high_chart("annual_event_histories", @annual_event_histories_chart) %></div>
    <div class='chart-wrapper'><%= high_chart("annual_participants",    @annual_participants_chart) %></div>
  </div>

  <h2 id="latest" style="margin-top: 70px; color: #333333;">
    <a href="#latest">ğŸ†•</a>
    <%= @lang == 'en' ? 'Latest Data' : 'æœ€æ–°ãƒ‡ãƒ¼ã‚¿' %>
  </h2>

  <p>
    <% if @lang == 'en' %>
      Latest statistics including <%= Time.current.year %> data<br><small>(actual values)</small> are as follows:
    <% else %>
      <%= Time.current.year %>å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚ãŸ<br>æœ€æ–°ã®çµ±è¨ˆæƒ…å ± <small>(å®Ÿæ¸¬å€¤)</small> ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚
    <% end %>
  </p>
  <div style="margin-top: 20px;" align="center">
    <table border="1" style="margin-top: 4px;">
      <tr>
        <th><%= @lang == 'en' ? 'Active Dojos' : 'æ²è¼‰ä¸­ã®é“å ´æ•°' %></th>
        <th><%= @lang == 'en' ? 'Total Events' : 'ç´¯è¨ˆé–‹å‚¬å›æ•°' %></th>
        <th><%= @lang == 'en' ? 'Total Participants' : 'ç´¯è¨ˆå‚åŠ è€…æ•°' %></th>
      </tr>
      <tr class="text-center">
        <td><%= @sum_of_dojos %></td>
        <td><%= @sum_of_events %></td>
        <td><%= @sum_of_participants %></td>
      </tr>
    </table>
  </div>

  <div id="tag" style="margin-top: 20px;" align="center">
    <br>
    <%= high_chart("dojo_tag_chart", @dojo_tag_chart) %>
  </div>

  <h2 id="table" style="margin-top: 70px; color: #333333;">
    <a href="#table">ğŸ“</a>
    <%= @lang == 'en' ? 'About Data Collection' : 'é›†è¨ˆæ–¹æ³•ã¨é›†è¨ˆå¯¾è±¡ã«ã¤ã„ã¦' %>
  </h2>
  <ul style="list-style: none; margin-left: -10px;">
    <% if @lang == 'en' %>
      <li>The number of participants is total count, not unique count.</li>
      <li>Only dojos that can be aggregated via APIs are included.</li>
    <% else %>
      <li>å‚åŠ è€…æ•°ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ã§ã¯ãªãå»¶ã¹æ•°ã§ã™ã€‚</li>
      <li>é›†è¨ˆå¯¾è±¡ã¯ API ãªã©ã§é›†è¨ˆå¯èƒ½ãªé“å ´ã§ã™ã€‚</li>
    <% end %>
  </ul>
  <p style="margin-top: 10px;">
    <% if @lang == 'en' %>
      Data is aggregated every Monday at 10:00 AM (JST).
      <br>
      The number of dojos included in the aggregation is as follows:
    <% else %>
      æ¯é€±æœˆæ›œæœ10æ™‚ã«é›†è¨ˆã‚’ã—ã¦ã„ã¾ã™ã€‚
      <br>
      é›†è¨ˆå¯¾è±¡ã®é“å ´æ•°ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚
    <% end %>
  </p>
  <p style="margin-top: 10px; margin-bottom: -5px;">
    <b><%= @annual_dojos_table[@period_end.to_s] %></b> /
    <b><%= @annual_dojos_whole[@period_end.to_s] %></b> Dojos
  </p>
  <span style="font-size: 10px;">
    <%= @lang == 'en' ? '(Including inactive dojos)' : 'ï¼ˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸé“å ´ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ï¼‰' %>
  </span>

  <style>
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
      max-width: 99%; /* æ¨ªå¹…ã‚’ç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ */
      margin: auto 5px;
    }
  </style>

  <div id="table-target" align="center" style="margin-top: 50px; scroll-margin-top: 80px;">
    <b>
      <a href="#table-target">ğŸ”</a>
      <%= @lang == 'en' ? 'Aggregation Target and Coverage Ratio' : 'é›†è¨ˆå¯¾è±¡ã¨é›†è¨ˆå‰²åˆã®æ¨ç§»' %>
    </b>
  </div>
  <div class="table-container" align="center">
    <table class="compact" border="1" style="margin-top: 10px;">
      <tr>
        <th>
          <span class="table-head"><%= @lang == 'en' ? 'Year' : 'è¥¿æš¦' %></span>
        </th>
        <% @period_range.each do |year| %>
          <th>
            <span class="table-head">â€™<%= year.to_s[2..] %></span>
          </th>
        <% end %>
      </tr>
      <tr style="text-align: center;">
        <td>
          <span class="table-head"><%= @lang == 'en' ? 'Aggregated' : 'é›†è¨ˆæ•°' %></span>
        </td>
        <% @annual_dojos_table.each_value do |num| %>
          <td>
            <span class="table-item"><%= num %></span>
          </td>
        <% end %>
      </tr>
      <tr style="text-align: center;">
        <td>
          <span class="table-head"><%= @lang == 'en' ? 'Total Dojos' : 'ç·é“å ´' %></span>
        </td>
        <% @annual_dojos_whole.each_value do |num| %>
          <td>
            <span class="table-item"><%= num %></span>
          </td>
        <% end %>
      </tr>
      <tr style="text-align: center;">
        <td>
          <span class="table-head"><%= @lang == 'en' ? 'Ratio' : 'å‰²åˆ' %></span>
          <span class="table-label">[%]</span>
        </td>
        <% @annual_dojos_ratio.each_value do |num| %>
          <td>
            <span class="table-item">
              <%= (num.eql?('100.0') ? '100' : num) %>
            </span>
          </td>
        <% end %>
      </tr>
    </table>
    <span style="font-size: 10px;">
      â€» <%= @lang == 'en' ? 'Including inactive dojos' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸé“å ´ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™' %>
    </span>
  </div>

  <div id="table-actual" align="center" style="margin-top: 50px; scroll-margin-top: 80px;">
    <b>
      <a href="#table-actual">â˜¯ï¸</a>
      <%= @lang == 'en' ? 'Events and Participants Trends' : 'é–‹å‚¬å›æ•°ã¨å‚åŠ è€…æ•°ã®æ¨ç§»' %>
    </b>
  </div>
  <div class="table-container" align="center">
    <table class="compact" border="1" style="margin-top: 10px;">
      <tr>
        <th>
          <span class="table-head"><%= @lang == 'en' ? 'Year' : 'è¥¿æš¦' %></span>
        </th>
        <% @period_range.each do |year| %>
          <th>
            <b>
              <span class="table-head">â€™<%= year.to_s[2..] %></span>
            </b>
          </th>
        <% end %>
      </tr>
      <tr style="text-align: center;">
        <td>
          <span class="table-head"><%= @lang == 'en' ? 'Ratio' : 'å‰²åˆ' %></span>
          <span class="table-label">[%]</span>
        </td>
        <% @annual_dojos_ratio.each_value do |num| %>
          <td>
            <span class="table-item">
              <%= num.eql?('100.0') ? '100' : num %>
            </span>
          </td>
        <% end %>
      </tr>
      <tr style="text-align: center;">
        <td>
          <span class="table-head"><%= @lang == 'en' ? 'Events' : 'é–‹å‚¬' %></span>
          <span class="table-label"><%= @lang == 'en' ? '(actual)' : '(é›†è¨ˆ)' %></span>
        </td>
        <% @annual_events_table.each_value.with_index(@period_start) do |num, year| %>
          <td>
            <span class="table-item"><%= num %></span>
          </td>
        <% end %>
      </tr>
      <tr style="text-align: center;">
        <td>
          <span class="table-head"><%= @lang == 'en' ? 'Participants' : 'å‚åŠ ' %></span>
          <span class="table-label"><%= @lang == 'en' ? '(actual)' : '(é›†è¨ˆ)' %></span>
        </td>
        <% @annual_participants_table.each_value.with_index(@period_start) do |num, year| %>
          <td>
            <span class="table-item"><%= num %></span>
          </td>
        <% end %>
      </tr>
    </table>
    <span style="font-size: 10px;">
      â€» <%= @lang == 'en' ? 'Data from the <a href="#graph">transition charts</a> above' : '<a href="#graph">å†’é ­ã®æ¨ç§»ã‚°ãƒ©ãƒ•</a> ã‚’è¡¨ã«ã—ãŸãƒ‡ãƒ¼ã‚¿ã§ã™' %>
    </span>
  </div>

  <div id="table-estimate" align="center" style="margin-top: 50px; scroll-margin-top: 80px;">
    <b>
      <a href="#table-estimate">ğŸ’­</a>
      <%= @lang == 'en' ? 'Estimated Events and Participants' : 'é–‹å‚¬å›æ•°ã¨å‚åŠ è€…æ•°ã®è¦‹è¾¼ã¿' %>
    </b>
  </div>
  <div class="table-container" align="center">
    <table class="compact" border="1" style="margin-top: 10px;">
      <tr>
        <th>
          <span class="table-head"><%= @lang == 'en' ? 'Year' : 'è¥¿æš¦' %></span>
        </th>
        <% @period_range.each do |year| %>
          <th>
            <b>
              <span class="table-head">â€™<%= year.to_s[2..] %></span>
            </b>
          </th>
        <% end %>
      </tr>
      <tr style="text-align: center;">
        <td>
          <span class="table-head"><%= @lang == 'en' ? 'Ratio' : 'å‰²åˆ' %></span>
          <span class="table-label">[%]</span>
        </td>
        <% @annual_dojos_ratio.each_value do |num| %>
          <td>
            <span class="table-item">
              <%= num.eql?('100.0') ? '100' : num %>
            </span>
          </td>
        <% end %>
      </tr>
      <tr style="text-align: center;">
        <td>
          <span class="table-head"><%= @lang == 'en' ? 'Events' : 'é–‹å‚¬' %></span>
          <span class="table-label"><%= @lang == 'en' ? '(estimated)' : '(è¦‹è¾¼)' %></span>
        </td>
        <% @annual_events_table.each_value.with_index(@period_start) do |num, year| %>
          <td>
            <span class="table-item">
              <%= Rational(num, Rational(@annual_dojos_ratio[year.to_s], 100)).to_i %>
            </span>
            <!--
            <span class="table-item"><%= num %></span>
            <span class="table-item"><%= Rational(@annual_dojos_ratio[year.to_s], 100) %></span>
            -->
          </td>
        <% end %>
      </tr>
      <tr style="text-align: center;">
        <td>
          <span class="table-head"><%= @lang == 'en' ? 'Participants' : 'å‚åŠ ' %></span>
          <span class="table-label"><%= @lang == 'en' ? '(estimated)' : '(è¦‹è¾¼)' %></span>
        </td>
        <% @annual_participants_table.each_value.with_index(@period_start) do |num, year| %>
          <td>
            <span class="table-item">
              <%= Rational(num, Rational(@annual_dojos_ratio[year.to_s], 100)).to_i %>
            </span>
          </td>
        <% end %>
      </tr>
    </table>
    <span style="font-size: 10px;">
      <% year = @period_end.to_s %>
      <% if @lang == 'en' %>
        â€» Calculation example for <%= year %> participants estimate:
        <%= @annual_participants_table[year] %> / 0.<%= @annual_dojos_ratio[year].remove('.') %>
        = <%= Rational(@annual_participants_table[year], Rational(@annual_dojos_ratio[year], 100)).to_i %>
        <small>(decimals are truncated)</small>
      <% else %>
        â€» <%= year %>å¹´ã®å‚åŠ è¦‹è¾¼ã®è¨ˆç®—ä¾‹:
        <%= @annual_participants_table[year] %> / 0.<%= @annual_dojos_ratio[year].remove('.') %>
        = <%= Rational(@annual_participants_table[year], Rational(@annual_dojos_ratio[year], 100)).to_i %>
        <small>(å°æ•°ç‚¹ä»¥ä¸‹ã¯åˆ‡ã‚Šæ¨ã¦)</small>
      <% end %>
    </span>
  </div>

  <h2 id="map" style="margin-top: 70px; color: #333333;">
    <a href="#map">ğŸ—¾</a>
    <%= @lang == 'en' ? 'Dojos by Region' : 'åœ°åŸŸåˆ¥ã®é“å ´æ•°' %>
  </h2>
  <div class="japan-map">
    <!-- 
    <p id="japan-map-text" style="margin: 20px auto; font-size: 140%;">
      åå‰: é“å ´æ•°
    </p>
    -->
    <div id="japan-map-container"></div>
  </div>
  <div style="margin-top: 0px; margin-bottom: 60px;" align="center">
    <p>
      <a href="<%= dojomap_url %>">&raquo; <%= @lang == 'en' ? 'View Map Data' : 'åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹' %></a><br>
      <a href="<%= dojos_path  %>">&raquo; <%= @lang == 'en' ? 'View Individual Data' : 'å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹' %></a><br>
    </p>
  </div>

  <!-- NOTE: Always show dojos with accordion style to compact -->
  <%= render partial: 'shared/dojos_stats', locals: { regions_and_dojos: @regions_and_dojos } %>

  <h2 id="prefectures" style="margin-top: 70px; color: #333333;">
    <a href="#prefectures">âœ…</a>
    <%= @lang == 'en' ? 'Dojos by Prefecture' : 'éƒ½é“åºœçœŒåˆ¥ã®é“å ´æ•°' %>
    <div style="padding-top: 10px; font-size: smaller;">
      <%= "(#{@data_by_prefecture_count} / #{Prefecture.count})" %>
    </div>
  </h2>
  <div style="margin-top: 20px;" align="center">
    <table border="1">
      <tr>
        <th style="padding: 10px;">
          <small><%= @lang == 'en' ? 'Prefecture' : 'éƒ½é“åºœçœŒå' %></small>
        </th>
        <th style="padding: 10px;">
          <small><%= @lang == 'en' ? 'Dojos' : 'é“å ´æ•°' %></small>
        </th>
      </tr>
      <% @data_by_prefecture.each_with_index do |(prefecture, count), index| %>
        <tr>
          <% if count == 0 %>
            <td style="background-color: gainsboro; padding: 0px;">
              <small><%= @lang == 'en' ? prefecture_name_in_english(prefecture) : prefecture %></small>
            </td>
            <td style="background-color: gainsboro; padding: 0px;">
              <small><%= count %></small>
            </td>
          <% else %>
            <td style="padding: 0px;">
              <small><%= @lang == 'en' ? prefecture_name_in_english(prefecture) : prefecture %></small>
            </td>
            <td style="padding: 0px;">
              <small><%= count %></small>
            </td>
          <% end %>
        </tr>
      <% end %>
    </table>
  </div>

  <h2 id="references" style="margin-top: 70px; color: #333333;">
    <a href="#references">ğŸ“š</a>
    <%= @lang == 'en' ? 'Related Links' : 'é–¢é€£ãƒªãƒ³ã‚¯' %>
  </h2>
  <ul>
    <li>
      <a href="https://bit.ly/coderdojo-japan-stats-past-works">
        çµ±è¨ˆæƒ…å ±ã«é–¢ã™ã‚‹ã€ã“ã‚Œã¾ã§ã€ã®é–‹ç™º - GitHub
      </a>
    </li>
    <li>
      <a href="https://bit.ly/coderdojo-japan-stats-future-works">
        çµ±è¨ˆæƒ…å ±ã«é–¢ã™ã‚‹ã€ã“ã‚Œã‹ã‚‰ã€ã®é–‹ç™º - GitHub
      </a>
    </li>
    <li>
      <a href="https://bit.ly/coderdojo-japan-stats-data-sheet">
        æ—¥æœ¬ã® CoderDojo (è²¡å›£&Japan) - Spreadsheet
      </a>
    </li>
  </ul>
  <br>
</section>

<style>
  span.table-head  { font-size: x-small; }
  span.table-label { font-size: 7px; }
  span.table-item  { font-size: xx-small; }
</style>

<script>
  $(function(){
    var areas      = JSON.parse('<%= @data_by_region.to_json.gsub(/&quot;/, "\"") %>');
    var dataByPref = JSON.parse('<%= @data_by_prefecture.to_json.gsub(/&quot;/, "\"") %>');

    $("#japan-map-container").japanMap({
      // NOTE: Tweak stats_controller if you want to tweak map colors
      areas: areas,
      selection: "prefecture",
      borderLineWidth: 0.1,
      drawsBoxLine: false,
      movesIslands: true,
      showsAreaName: true,
      showsPrefectureName: false,
      prefectureNameType: "short",
      width: 651,
      font: "Hiragino Kaku Gothic Pro",
      fontSize: 12,
      fontColor: "white",
      fontShadowColor: "#444455",
      onSelect: function(data){
        // This code is used for tapping by Mobile devices
        $("#japan-map-text").html(data.name + ": " + dataByPref[data.name]);
      },
      onHover: function(data){
        $("#japan-map-text").html(data.name + ": " + dataByPref[data.name]);
      }
    });
  });
</script>
