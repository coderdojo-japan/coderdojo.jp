name: Daily Workflow

on:
  schedule:
    # æ¯æœ 9:00 JST
    - cron: '0 0 * * *'
  # Allows you to run this workflow manually from the Actions tab
  # https://docs.github.com/en/actions/managing-workflow-runs/manually-running-a-workflow
  workflow_dispatch:

jobs:
  daily:
    runs-on: ubuntu-latest
    outputs:
      FOUND_NEWS: ${{ steps.check_news.outputs.FOUND_NEWS }}

    steps:
    - name: â˜‘ï¸ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ğŸ’ Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        bundler-cache: true

    - name: ğŸ“° Run news:fetch task
      run: bin/rails news:fetch

    - name: ğŸ†™ Commit updated news.yml
      id: check_news
      run: |
        git config user.name  "Yohei Yasukawa"
        git config user.email "yohei@yasslab.jp"
        git checkout main
        git add db/news.yml
        if ! git diff --cached --quiet; then
          git commit -m 'ğŸ¤– Upsert db/news.yml'
          git push origin main
          echo "ğŸ†• Found news in db/news.yml"
          echo "FOUND_NEWS=true"  >> $GITHUB_OUTPUT
        else
          echo "âœ… No news in db/news.yml"
          echo "FOUND_NEWS=false" >> $GITHUB_OUTPUT
        fi

  run-on-heroku:
    needs: daily
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ“¦ Install Heroku CLI
      run: curl https://cli-assets.heroku.com/install.sh | sh

    - name: ğŸ“… Run upcoming_events:aggregation on Heroku
      run: |
        heroku run rails upcoming_events:aggregation --app $HEROKU_APP_NAME
      env:
        HEROKU_API_KEY:  ${{ secrets.HEROKU_API_KEY  }}
        HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}

  deploy:
    needs: daily
    if: ${{ needs.daily.outputs.FOUND_NEWS == 'true' }}
    # TODO: ubuntu-latest image needs to install heroku CLI to deploy.
    # https://github.com/AkhileshNS/heroku-deploy/issues/188
    runs-on: ubuntu-22.04

    steps:
    - name: â˜‘ï¸ Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: ğŸš€ Deploy to Heroku
      uses: akhileshns/heroku-deploy@v3.14.15
      with:
        heroku_api_key:  ${{ secrets.HEROKU_API_KEY  }}
        heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
        heroku_email:    ${{ secrets.HEROKU_EMAIL    }}
