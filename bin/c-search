#!/usr/bin/env ruby

require 'connpass_api_v2'
require 'uri'
require 'net/http'
require 'json'

HOW_TO_USE_MESSAGE = <<~MESSAGE
  Usage: c-search [CONNPASS_URL | CONNPASS_EVENT_ID]
    例: c-search https://coderdojoaoyama.connpass.com/
    例: c-search https://coderdojoaoyama.connpass.com/event/356972/
    例: c-search 356972
MESSAGE

if ARGV.empty? || ARGV[0].end_with?('event', 'event/')
  puts HOW_TO_USE_MESSAGE
  exit 1
end

input   = ARGV[0]
api_key = ENV['CONNPASS_API_KEY']

# 数字のみ、またはイベントURLの場合
if input =~ /\A(\d+)$/ or input =~ /event\/(\d+)/
  event_id = $1
  client   = ConnpassApiV2.client(api_key)
  result   = client.get_events(event_id: event_id)
  puts result.events.first['group']['id']

# グループURLの場合
elsif input =~ /\Ahttps:\/\/([\w-]+)\.connpass\.com/
  subdomain = $1
  uri       = URI('https://connpass.com/api/v2/groups/')
  uri.query = URI.encode_www_form(subdomain: subdomain, count: 1)

  req              = Net::HTTP::Get.new(uri)
  req['X-Api-Key'] = api_key

  response = Net::HTTP.start(uri.hostname, uri.port, use_ssl: true) { it.request req }
  result   = JSON.parse(response.body)
  puts result['groups'].first['id']

else
  puts HOW_TO_USE_MESSAGE
  exit 1
end
